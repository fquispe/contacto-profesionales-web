<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informaci√≥n Personal - ServiciosPro</title>
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #28a745;
            --error-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-gray: #f8f9fa;
            --medium-gray: #6c757d;
            --dark-gray: #343a40;
            --border-color: #e9ecef;
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 24px;
            box-shadow: var(--shadow);
            overflow: hidden;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 35px 40px;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .header-icon {
            font-size: 36px;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -1px;
        }

        .header-subtitle {
            font-size: 15px;
            opacity: 0.95;
            margin-left: 51px;
        }

        .back-button {
            position: absolute;
            top: 35px;
            right: 40px;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            z-index: 2;
        }

        .back-button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateX(-3px);
        }

        .content {
            padding: 40px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            transition: width 1s ease-out;
            border-radius: 10px;
        }

        .progress-text {
            text-align: center;
            color: var(--medium-gray);
            font-size: 14px;
            margin-bottom: 30px;
        }

        .section {
            background: var(--light-gray);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 25px;
            border: 2px solid var(--border-color);
            transition: var(--transition);
        }

        .section:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .section-icon {
            font-size: 28px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark-gray);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .form-grid.single {
            grid-template-columns: 1fr;
        }

        .form-group {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark-gray);
            font-weight: 600;
            font-size: 14px;
        }

        .required {
            color: var(--error-color);
            margin-left: 4px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 15px;
            background: white;
            color: var(--dark-gray);
            transition: var(--transition);
            font-family: inherit;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .form-input:disabled, .form-select:disabled {
            background: var(--light-gray);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .form-input.error {
            border-color: var(--error-color);
            background: #fff5f5;
        }

        .error-message {
            color: var(--error-color);
            font-size: 13px;
            margin-top: 6px;
            display: none;
        }

        .helper-text {
            font-size: 13px;
            color: var(--medium-gray);
            margin-top: 6px;
        }

        .photo-upload {
            text-align: center;
            padding: 30px;
            background: white;
            border: 3px dashed var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
        }

        .photo-upload:hover {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.05);
        }

        .photo-preview {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 0 auto 20px;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 64px;
            overflow: hidden;
        }

        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-text {
            color: var(--medium-gray);
            font-size: 14px;
        }

        .photo-text strong {
            color: var(--primary-color);
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: white;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        .btn-secondary:hover {
            background: var(--primary-color);
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .alert {
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: none;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .alert-success {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success-color);
            border: 2px solid var(--success-color);
        }

        .alert-error {
            background: rgba(220, 53, 69, 0.1);
            color: var(--error-color);
            border: 2px solid var(--error-color);
        }

        .alert-info {
            background: rgba(23, 162, 184, 0.1);
            color: var(--info-color);
            border: 2px solid var(--info-color);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                border-radius: 20px;
            }

            .header {
                padding: 25px 20px;
            }

            .header h1 {
                font-size: 24px;
            }

            .back-button {
                position: static;
                margin-top: 15px;
                width: 100%;
            }

            .content {
                padding: 25px 20px;
            }

            .section {
                padding: 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column-reverse;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <button class="back-button" onclick="volverDashboard()">
                ‚Üê Volver al Dashboard
            </button>
            <div class="header-content">
                <div class="header-title">
                    <span class="header-icon">üë§</span>
                    <h1>Informaci√≥n Personal</h1>
                </div>
                <p class="header-subtitle">Completa y actualiza tus datos personales</p>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Progress Bar -->
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <div class="progress-text" id="progressText">Completitud: 0%</div>

            <!-- Alert Container -->
            <div id="alertContainer"></div>

            <!-- Form -->
            <form id="personalInfoForm">
                <!-- Secci√≥n: Informaci√≥n B√°sica -->
                <div class="section">
                    <div class="section-header">
                        <span class="section-icon">üìù</span>
                        <h2 class="section-title">Informaci√≥n B√°sica</h2>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">
                                Nombre Completo<span class="required">*</span>
                            </label>
                            <input 
                                type="text" 
                                id="nombreCompleto" 
                                name="nombreCompleto" 
                                class="form-input"
                                placeholder="Ej: Juan P√©rez Garc√≠a"
                                required
                            >
                            <div class="error-message" id="nombreCompletoError"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                Correo Electr√≥nico<span class="required">*</span>
                            </label>
                            <input 
                                type="email" 
                                id="email" 
                                name="email" 
                                class="form-input"
                                placeholder="correo@ejemplo.com"
                                disabled
                            >
                            <p class="helper-text">El correo no se puede modificar</p>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">
                                Tel√©fono Principal<span class="required">*</span>
                            </label>
                            <input 
                                type="tel" 
                                id="telefono" 
                                name="telefono" 
                                class="form-input"
                                placeholder="987654321"
                                maxlength="9"
                                required
                            >
                            <div class="error-message" id="telefonoError"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tel√©fono Alternativo</label>
                            <input 
                                type="tel" 
                                id="telefonoAlternativo" 
                                name="telefonoAlternativo" 
                                class="form-input"
                                placeholder="987654321"
                                maxlength="9"
                            >
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n: Documento de Identidad -->
                <div class="section">
                    <div class="section-header">
                        <span class="section-icon">üÜî</span>
                        <h2 class="section-title">Documento de Identidad</h2>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">
                                Tipo de Documento<span class="required">*</span>
                            </label>
                            <select 
                                id="tipoDocumento" 
                                name="tipoDocumento" 
                                class="form-select"
                                required
                            >
                                <option value="">Seleccione...</option>
                                <option value="DNI">DNI</option>
                                <option value="CE">Carnet de Extranjer√≠a</option>
                                <option value="PASAPORTE">Pasaporte</option>
                                <option value="RUC">RUC</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                N√∫mero de Documento<span class="required">*</span>
                            </label>
                            <input 
                                type="text" 
                                id="numeroDocumento" 
                                name="numeroDocumento" 
                                class="form-input"
                                placeholder="12345678"
                                required
                            >
                            <div class="error-message" id="numeroDocumentoError"></div>
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n: Informaci√≥n Personal -->
                <div class="section">
                    <div class="section-header">
                        <span class="section-icon">üéÇ</span>
                        <h2 class="section-title">Datos Personales</h2>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Fecha de Nacimiento</label>
                            <input 
                                type="date" 
                                id="fechaNacimiento" 
                                name="fechaNacimiento" 
                                class="form-input"
                            >
                        </div>
                        <div class="form-group">
                            <label class="form-label">G√©nero</label>
                            <select 
                                id="genero" 
                                name="genero" 
                                class="form-select"
                            >
                                <option value="">Seleccione...</option>
                                <option value="MASCULINO">Masculino</option>
                                <option value="FEMENINO">Femenino</option>
                                <option value="OTRO">Otro</option>
                                <option value="PREFIERO_NO_DECIR">Prefiero no decir</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n: Ubicaci√≥n -->
                <div class="section">
                    <div class="section-header">
                        <span class="section-icon">üìç</span>
                        <h2 class="section-title">Ubicaci√≥n</h2>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Departamento</label>
                            <select 
                                id="departamento" 
                                name="departamento" 
                                class="form-select"
                                onchange="cargarProvincias()"
                            >
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Provincia</label>
                            <select 
                                id="provincia" 
                                name="provincia" 
                                class="form-select"
                                onchange="cargarDistritos()"
                                disabled
                            >
                                <option value="">Seleccione departamento primero...</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Distrito</label>
                            <select 
                                id="distrito" 
                                name="distrito" 
                                class="form-select"
                                disabled
                            >
                                <option value="">Seleccione provincia primero...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Direcci√≥n</label>
                            <input 
                                type="text" 
                                id="direccion" 
                                name="direccion" 
                                class="form-input"
                                placeholder="Ej: Av. Principal 123"
                            >
                        </div>
                    </div>
                    <div class="form-grid single">
                        <div class="form-group">
                            <label class="form-label">Referencia de Direcci√≥n</label>
                            <input 
                                type="text" 
                                id="referenciaDireccion" 
                                name="referenciaDireccion" 
                                class="form-input"
                                placeholder="Ej: Cerca al parque principal, edificio azul"
                            >
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n: Foto de Perfil -->
                <div class="section">
                    <div class="section-header">
                        <span class="section-icon">üì∑</span>
                        <h2 class="section-title">Foto de Perfil</h2>
                    </div>
                    <div class="photo-upload" onclick="document.getElementById('fotoInput').click()">
                        <div class="photo-preview" id="photoPreview">
                            üë§
                        </div>
                        <p class="photo-text">
                            <strong>Click aqu√≠</strong> para subir tu foto de perfil<br>
                            <small>JPG, PNG (m√°x. 2MB)</small>
                        </p>
                        <input 
                            type="file" 
                            id="fotoInput" 
                            accept="image/*" 
                            style="display: none;"
                            onchange="previewImage(event)"
                        >
                    </div>
                </div>

                <!-- Botones de Acci√≥n -->
                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="volverDashboard()">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        Guardar Informaci√≥n
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let userData = {};
        let usuarioPersonaId = null;
        let departamentos = [];
        let provincias = [];
        let distritos = [];

        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
		    // Obtener datos del usuario del localStorage
		    userData = JSON.parse(localStorage.getItem('userData') || '{}');
		    
		    if (!userData.id) {
		        alert('Sesi√≥n no v√°lida. Por favor inicie sesi√≥n nuevamente.');
		        window.location.href = 'login.html';
		        return;
		    }
		
		    // Obtener usuarioPersonaId del localStorage
		    usuarioPersonaId = userData.usuarioPersonaId;
		
		    console.log('Usuario cargado:', {
		        userId: userData.id,
		        email: userData.email,
		        usuarioPersonaId: usuarioPersonaId
		    });
		
		    // Mostrar email (no editable)
		    document.getElementById('email').value = userData.email || '';
		
		    // Cargar departamentos primero
		    await cargarDepartamentos();
		
		    // Cargar datos existentes del usuario
		    if (usuarioPersonaId) {
		        console.log('Cargando datos existentes del usuario persona ID:', usuarioPersonaId);
		        await cargarDatosUsuario();
		    } else {
		        console.log('Usuario nuevo sin datos personales previos');
		        // Prellenar con lo b√°sico que tenemos
		        if (userData.nombreCompleto) {
		            document.getElementById('nombreCompleto').value = userData.nombreCompleto;
		        }
		        if (userData.telefono) {
		            document.getElementById('telefono').value = userData.telefono;
		        }
		    }
		
		    // Configurar validaciones
		    setupValidations();
		
		    // Configurar env√≠o del formulario
		    document.getElementById('personalInfoForm').addEventListener('submit', handleSubmit);
		
		    // Calcular completitud inicial
		    calcularCompletitud();
		});

        // ============================================
        // CARGAR DATOS DEL USUARIO
        // ============================================
        async function cargarDatosUsuario() {
		    if (!usuarioPersonaId) {
		        console.log('No hay usuarioPersonaId, es un registro nuevo');
		        return;
		    }
		
		    try {
		        console.log('Obteniendo datos de usuario persona desde el backend...');
		        
		        // Llamar al API para obtener los datos completos
		        const response = await fetch(`./api/usuario-persona/${usuarioPersonaId}`);
		        
		        if (!response.ok) {
		            if (response.status === 404) {
		                console.log('Usuario persona no encontrado en BD, es un registro nuevo');
		                return;
		            }
		            throw new Error(`Error HTTP: ${response.status}`);
		        }
		
		        const data = await response.json();
		        console.log('Respuesta del servidor:', data);
		
		        if (data.success && data.data) {
		            console.log('Datos recibidos, rellenando formulario...');
		            rellenarFormulario(data.data);
		        } else {
		            console.warn('No se recibieron datos del usuario persona');
		        }
		
		    } catch (error) {
		        console.error('Error al cargar datos del usuario:', error);
		        showAlert('‚ö†Ô∏è No se pudieron cargar algunos datos. Puedes continuar ingres√°ndolos manualmente.', 'info');
		    }
		}

        function rellenarFormulario(data) {
            console.log('Rellenando formulario con:', data);

            // Informaci√≥n b√°sica
            if (data.nombreCompleto) {
                document.getElementById('nombreCompleto').value = data.nombreCompleto;
                console.log('Nombre completo:', data.nombreCompleto);
            }
            if (data.telefono) {
                document.getElementById('telefono').value = data.telefono;
                console.log('Tel√©fono:', data.telefono);
            }
            if (data.telefonoAlternativo) {
                document.getElementById('telefonoAlternativo').value = data.telefonoAlternativo;
            }

            // Documento
            if (data.tipoDocumento) {
                document.getElementById('tipoDocumento').value = data.tipoDocumento;
                console.log('Tipo documento:', data.tipoDocumento);
            }
            if (data.numeroDocumento) {
                document.getElementById('numeroDocumento').value = data.numeroDocumento;
                console.log('N√∫mero documento:', data.numeroDocumento);
            }

            // Datos personales
            if (data.fechaNacimiento) {
                document.getElementById('fechaNacimiento').value = data.fechaNacimiento;
            }
            if (data.genero) {
                document.getElementById('genero').value = data.genero;
            }

            // Ubicaci√≥n - cargar en cascada
            if (data.departamentoId) {
                console.log('Cargando ubicaci√≥n: Depto', data.departamentoId);
                document.getElementById('departamento').value = data.departamentoId;
                
                cargarProvincias().then(() => {
                    if (data.provinciaId) {
                        console.log('Cargando provincia:', data.provinciaId);
                        document.getElementById('provincia').value = data.provinciaId;
                        
                        cargarDistritos().then(() => {
                            if (data.distritoId) {
                                console.log('Cargando distrito:', data.distritoId);
                                document.getElementById('distrito').value = data.distritoId;
                            }
                        });
                    }
                });
            }

            if (data.direccion) {
                document.getElementById('direccion').value = data.direccion;
            }
            if (data.referenciaDireccion) {
                document.getElementById('referenciaDireccion').value = data.referenciaDireccion;
            }

            // Foto de perfil
            if (data.fotoPerfilUrl) {
                document.getElementById('photoPreview').innerHTML = 
                    `<img src="${data.fotoPerfilUrl}" alt="Foto de perfil">`;
            }

            console.log('Formulario rellenado completamente');
        }

        // ============================================
        // UBICACI√ìN (UBIGEO)
        // ============================================
        async function cargarDepartamentos() {
            try {
                const response = await fetch('./api/ubicacion/departamentos');
                const data = await response.json();
                
                if (data.success && data.data) {
                    departamentos = data.data;
                    const select = document.getElementById('departamento');
                    
                    departamentos.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept.id;
                        option.textContent = dept.nombre;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error al cargar departamentos:', error);
            }
        }

        async function cargarProvincias() {
            const departamentoId = document.getElementById('departamento').value;
            const provinciaSelect = document.getElementById('provincia');
            const distritoSelect = document.getElementById('distrito');

            // Limpiar selects
            provinciaSelect.innerHTML = '<option value="">Seleccione...</option>';
            distritoSelect.innerHTML = '<option value="">Seleccione provincia primero...</option>';
            distritoSelect.disabled = true;

            if (!departamentoId) {
                provinciaSelect.disabled = true;
                return;
            }

            try {
                const response = await fetch(`./api/ubicacion/provincias?departamentoId=${departamentoId}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    provincias = data.data;
                    provincias.forEach(prov => {
                        const option = document.createElement('option');
                        option.value = prov.id;
                        option.textContent = prov.nombre;
                        provinciaSelect.appendChild(option);
                    });
                    provinciaSelect.disabled = false;
                }
            } catch (error) {
                console.error('Error al cargar provincias:', error);
            }
        }

        async function cargarDistritos() {
            const provinciaId = document.getElementById('provincia').value;
            const distritoSelect = document.getElementById('distrito');

            distritoSelect.innerHTML = '<option value="">Seleccione...</option>';

            if (!provinciaId) {
                distritoSelect.disabled = true;
                return;
            }

            try {
                const response = await fetch(`./api/ubicacion/distritos?provinciaId=${provinciaId}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    distritos = data.data;
                    distritos.forEach(dist => {
                        const option = document.createElement('option');
                        option.value = dist.id;
                        option.textContent = dist.nombre;
                        distritoSelect.appendChild(option);
                    });
                    distritoSelect.disabled = false;
                }
            } catch (error) {
                console.error('Error al cargar distritos:', error);
            }
        }

        // ============================================
        // PREVIEW DE IMAGEN
        // ============================================
        function previewImage(event) {
		    const file = event.target.files[0];
		    if (file) {
		        // Validar tama√±o (m√°x 2MB)
		        if (file.size > 2 * 1024 * 1024) {
		            showAlert('La imagen no debe superar los 2MB', 'error');
		            event.target.value = '';
		            return;
		        }
		
		        // Validar tipo
		        if (!file.type.startsWith('image/')) {
		            showAlert('Por favor selecciona una imagen v√°lida', 'error');
		            event.target.value = '';
		            return;
		        }
		
		        // Guardar archivo para subir despu√©s
		        imagenPendiente = file;
		
		        // Mostrar preview
		        const reader = new FileReader();
		        reader.onload = function(e) {
		            document.getElementById('photoPreview').innerHTML = 
		                `<img src="${e.target.result}" alt="Preview">`;
		        };
		        reader.readAsDataURL(file);
		    }
		}

        
	    // ============================================
	    // SUBIR IMAGEN AL SERVIDOR
	    // ============================================
	    async function uploadImage() {
	         if (!imagenPendiente) {
	             return null; // No hay imagen nueva
	         }
	
	         try {
	             const formData = new FormData();
	             formData.append('file', imagenPendiente);
	
	             const response = await fetch('./api/upload-image', {
	                 method: 'POST',
	                 body: formData
	             });
	
	             const data = await response.json();
	
	             if (data.success && data.data && data.data.url) {
	                 console.log('Imagen subida exitosamente:', data.data.url);
	                 return data.data.url;
	             } else {
	                 throw new Error(data.message || 'Error al subir imagen');
	             }
	
	         } catch (error) {
	             console.error('Error al subir imagen:', error);
	             throw error;
	         }
	     }
        
        // ============================================
        // VALIDACIONES
        // ============================================
        function setupValidations() {
            document.getElementById('telefono').addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
            });

            document.getElementById('telefonoAlternativo').addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
            });

            document.getElementById('numeroDocumento').addEventListener('input', function(e) {
                const tipo = document.getElementById('tipoDocumento').value;
                if (tipo === 'DNI' || tipo === 'RUC') {
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                }
            });

            // Calcular completitud al cambiar campos
            const campos = document.querySelectorAll('.form-input, .form-select');
            campos.forEach(campo => {
                campo.addEventListener('change', calcularCompletitud);
            });
        }

        function validarFormulario() {
            let isValid = true;

            // Nombre completo
            const nombre = document.getElementById('nombreCompleto').value.trim();
            if (nombre.length < 3) {
                showFieldError('nombreCompleto', 'El nombre debe tener al menos 3 caracteres');
                isValid = false;
            } else {
                clearFieldError('nombreCompleto');
            }

            // Tel√©fono
            const telefono = document.getElementById('telefono').value.trim();
            if (telefono.length !== 9) {
                showFieldError('telefono', 'El tel√©fono debe tener 9 d√≠gitos');
                isValid = false;
            } else {
                clearFieldError('telefono');
            }

            // Documento
            const tipoDoc = document.getElementById('tipoDocumento').value;
            const numeroDoc = document.getElementById('numeroDocumento').value.trim();
            
            if (tipoDoc && numeroDoc) {
                if (tipoDoc === 'DNI' && numeroDoc.length !== 8) {
                    showFieldError('numeroDocumento', 'El DNI debe tener 8 d√≠gitos');
                    isValid = false;
                } else if (tipoDoc === 'RUC' && numeroDoc.length !== 11) {
                    showFieldError('numeroDocumento', 'El RUC debe tener 11 d√≠gitos');
                    isValid = false;
                } else {
                    clearFieldError('numeroDocumento');
                }
            }

            return isValid;
        }

        // ============================================
        // CALCULAR COMPLETITUD
        // ============================================
        function calcularCompletitud() {
            const camposTotal = 14; // Total de campos importantes
            let camposCompletos = 0;

            // Lista de campos a verificar
            const campos = [
                'nombreCompleto', 'telefono', 'tipoDocumento', 'numeroDocumento',
                'fechaNacimiento', 'genero', 'departamento', 'provincia',
                'distrito', 'direccion', 'referenciaDireccion', 'telefonoAlternativo'
            ];

            campos.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento && elemento.value && elemento.value.trim() !== '') {
                    camposCompletos++;
                }
            });

            // Verificar foto
            const photoPreview = document.getElementById('photoPreview');
            if (photoPreview.querySelector('img')) {
                camposCompletos++;
            }

            // Email siempre cuenta
            if (document.getElementById('email').value) {
                camposCompletos++;
            }

            const porcentaje = Math.round((camposCompletos / camposTotal) * 100);

            // Actualizar barra de progreso
            document.getElementById('progressFill').style.width = porcentaje + '%';
            document.getElementById('progressText').textContent = `Completitud: ${porcentaje}%`;
        }

        // ============================================
        // ENV√çO DEL FORMULARIO
        // ============================================
        async function handleSubmit(e) {
		    e.preventDefault();
		
		    if (!validarFormulario()) {
		        return;
		    }
		
		    const submitBtn = document.getElementById('submitBtn');
		    submitBtn.disabled = true;
		    submitBtn.innerHTML = '<span class="loading"></span>Guardando...';
		
		    try {
		        // PRIMERO: Subir imagen si hay una nueva
		        let fotoUrl = null;
		        if (imagenPendiente) {
		            submitBtn.innerHTML = '<span class="loading"></span>Subiendo imagen...';
		            try {
		                fotoUrl = await uploadImage();
		                console.log('URL de imagen obtenida:', fotoUrl);
		            } catch (error) {
		                showAlert('‚ö†Ô∏è Error al subir la imagen. Se guardar√° sin foto.', 'error');
		                console.error('Error subiendo imagen:', error);
		            }
		        }
		
		        submitBtn.innerHTML = '<span class="loading"></span>Guardando informaci√≥n...';
		
		        // Preparar datos
		        const formData = {
		            nombreCompleto: document.getElementById('nombreCompleto').value.trim(),
		            telefono: document.getElementById('telefono').value.trim(),
		            telefonoAlternativo: document.getElementById('telefonoAlternativo').value.trim() || null,
		            tipoDocumento: document.getElementById('tipoDocumento').value || null,
		            numeroDocumento: document.getElementById('numeroDocumento').value.trim() || null,
		            fechaNacimiento: document.getElementById('fechaNacimiento').value || null,
		            genero: document.getElementById('genero').value || null,
		            departamentoId: document.getElementById('departamento').value ? 
		                parseInt(document.getElementById('departamento').value) : null,
		            provinciaId: document.getElementById('provincia').value ? 
		                parseInt(document.getElementById('provincia').value) : null,
		            distritoId: document.getElementById('distrito').value ? 
		                parseInt(document.getElementById('distrito').value) : null,
		            direccion: document.getElementById('direccion').value.trim() || null,
		            referenciaDireccion: document.getElementById('referenciaDireccion').value.trim() || null,
		            fotoPerfilUrl: fotoUrl || null // URL de la imagen subida
		        };
		
		        console.log('Datos a enviar:', formData);
		        console.log('UsuarioPersonaId actual:', usuarioPersonaId);
		
		        // Determinar si es actualizaci√≥n o creaci√≥n
		        let url, method;
		        
		        if (usuarioPersonaId) {
		            // ACTUALIZACI√ìN
		            url = `./api/usuario-persona/${usuarioPersonaId}`;
		            method = 'PUT';
		            console.log('Modo: ACTUALIZACI√ìN');
		        } else {
		            // CREACI√ìN - incluir userId en el body
		            url = './api/usuario-persona';
		            method = 'POST';
		            formData.userId = userData.id;
		            console.log('Modo: CREACI√ìN NUEVA');
		        }
		
		        console.log(`Enviando ${method} a ${url}`);
		
		        const response = await fetch(url, {
		            method: method,
		            headers: {
		                'Content-Type': 'application/json'
		            },
		            body: JSON.stringify(formData)
		        });
		
		        const data = await response.json();
		        console.log('Respuesta del servidor:', data);
		
		        if (data.success) {
		            showAlert('‚úÖ Informaci√≥n guardada exitosamente', 'success');
		            
		            // Limpiar imagen pendiente
		            imagenPendiente = null;
		            
		            // Si era creaci√≥n, guardar el nuevo usuarioPersonaId
		            if (!usuarioPersonaId && data.data && data.data.id) {
		                usuarioPersonaId = data.data.id;
		                userData.usuarioPersonaId = usuarioPersonaId;
		                localStorage.setItem('userData', JSON.stringify(userData));
		                console.log('Nuevo usuarioPersonaId guardado:', usuarioPersonaId);
		            }
		
		            // Actualizar localStorage con los nuevos datos
		            userData = { ...userData, ...formData };
		            localStorage.setItem('userData', JSON.stringify(userData));
		            console.log('userData actualizado en localStorage');
		
		            // Redirigir despu√©s de 2 segundos
		            setTimeout(() => {
		                window.location.href = 'dashboard.html';
		            }, 2000);
		        } else {
		            showAlert('‚ùå ' + (data.message || 'Error al guardar la informaci√≥n'), 'error');
		        }
		
		    } catch (error) {
		        console.error('Error al enviar formulario:', error);
		        showAlert('‚ùå Error de conexi√≥n con el servidor', 'error');
		    } finally {
		        submitBtn.disabled = false;
		        submitBtn.innerHTML = 'Guardar Informaci√≥n';
		    }
		}

        // ============================================
        // FUNCIONES AUXILIARES
        // ============================================
        function showFieldError(fieldId, message) {
            const input = document.getElementById(fieldId);
            const errorElement = document.getElementById(fieldId + 'Error');
            input.classList.add('error');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }

        function clearFieldError(fieldId) {
            const input = document.getElementById(fieldId);
            const errorElement = document.getElementById(fieldId + 'Error');
            input.classList.remove('error');
            if (errorElement) {
                errorElement.textContent = '';
                errorElement.style.display = 'none';
            }
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.display = 'block';
            
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alert);

            // Auto-ocultar despu√©s de 5 segundos
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function volverDashboard() {
            if (confirm('¬øEst√°s seguro? Los cambios no guardados se perder√°n.')) {
                window.location.href = 'dashboard.html';
            }
        }
    </script>
</body>
</html>